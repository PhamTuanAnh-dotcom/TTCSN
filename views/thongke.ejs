<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Thá»‘ng kÃª doanh thu</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    .filter { margin-bottom: 20px; }
    .card { padding: 15px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>ğŸ“Š Thá»‘ng kÃª doanh thu</h1>

  <div class="filter">
    <label>Chá»n thÃ¡ng: </label>
    <input type="month" id="monthPicker" />
    <button onclick="loadStats()">Xem</button>
  </div>

  <div class="card">
    <h3>Doanh thu thÃ¡ng</h3>
    <p id="tongDoanhThu">0 VND</p>
  </div>

  <div class="card">
    <h3>Biá»ƒu Ä‘á»“ doanh thu theo ngÃ y</h3>
    <canvas id="revenueChart"></canvas>
  </div>

  <div class="card">
    <h3>MÃ³n Ä‘Æ°á»£c order nhiá»u nháº¥t</h3>
    <p id="monNhieuNhat">Äang táº£i...</p>

    <h3>MÃ³n Ä‘Æ°á»£c order Ã­t nháº¥t</h3>
    <p id="monItNhat">Äang táº£i...</p>
  </div>

  <div class="card">
    <h3>NhÃ¢n viÃªn order nhiá»u nháº¥t</h3>
    <p id="nvNhieuNhat">Äang táº£i...</p>
  </div>

  <script>
    let chart;

    function formatVND(amount) {
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    function loadStats() {
      const month = document.getElementById("monthPicker").value;
      if (!month) return alert("Vui lÃ²ng chá»n thÃ¡ng!");

      fetch(`/api/thongke?month=${month}`)
        .then(res => res.json())
        .then(data => {
          // Doanh thu tá»•ng
          document.getElementById("tongDoanhThu").innerText = formatVND(data.tongDoanhThu);

          // MÃ³n nhiá»u nháº¥t / Ã­t nháº¥t
          document.getElementById("monNhieuNhat").innerText = data.monNhieuNhat.TenMon 
            ? `${data.monNhieuNhat.TenMon} - ${data.monNhieuNhat.SoLuong} mÃ³n`
            : "ChÆ°a cÃ³ dá»¯ liá»‡u";
          document.getElementById("monItNhat").innerText = data.monItNhat.TenMon 
            ? `${data.monItNhat.TenMon} - ${data.monItNhat.SoLuong} mÃ³n`
            : "ChÆ°a cÃ³ dá»¯ liá»‡u";

          // NhÃ¢n viÃªn nhiá»u nháº¥t
          document.getElementById("nvNhieuNhat").innerText = data.nvNhieuNhat.staffName 
            ? `${data.nvNhieuNhat.staffName} - ${data.nvNhieuNhat.numOrders} order`
            : "ChÆ°a cÃ³ dá»¯ liá»‡u";

          // Biá»ƒu Ä‘á»“ doanh thu theo ngÃ y
          if (chart) chart.destroy();
          chart = new Chart(document.getElementById("revenueChart"), {
            type: "bar",
            data: {
              labels: data.labels,
              datasets: [{
                label: "Doanh thu (VND)",
                data: data.values,
                backgroundColor: "#0d6efd"
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                y: { 
                  ticks: { callback: function(value) { return value.toLocaleString('vi-VN') + 'â‚«'; } }
                }
              }
            }
          });
        })
        .catch(err => {
          console.error(err);
          alert("Lá»—i khi táº£i dá»¯ liá»‡u thá»‘ng kÃª");
        });
    }
  </script>
</body>
</html>
